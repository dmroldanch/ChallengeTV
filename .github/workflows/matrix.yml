name: Android CI

on:
  push:
    branches: [ "main", "develop", "feature/rick_and_morty" ]
  pull_request:
    branches: [ "main", "develop", "feature/rick_and_morty" ]

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build with Gradle
        uses: gradle/gradle-build-action@v3
        with:
          arguments: build

  test-and-coverage:
    name: Tests & Coverage
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run unit tests with coverage and print percentage
        run: ./gradlew app:jacocoTestReport app:printJacocoCoverage

      - name: Coverage summary (Markdown)
        if: always()
        run: |
          REPORT="app/build/reports/jacoco/jacocoTestReport/jacocoTestReport.xml"

          if [ ! -f "$REPORT" ]; then
            echo "## Test & Coverage summary" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "Jacoco XML report not found: \`$REPORT\`" >> "$GITHUB_STEP_SUMMARY"
            exit 0
          fi

          python3 - << 'PY'
  import xml.etree.ElementTree as ET
  import os
  
  report = "app/build/reports/jacoco/jacocoTestReport/jacocoTestReport.xml"
  step_summary = os.environ.get("GITHUB_STEP_SUMMARY")
  
  tree = ET.parse(report)
  root = tree.getroot()
  
  counters = [c for c in root.findall("counter") if c.get("type") == "LINE"]
  missed = sum(int(c.get("missed", 0)) for c in counters)
  covered = sum(int(c.get("covered", 0)) for c in counters)
  total = missed + covered
  coverage = (covered / total * 100) if total else 0.0
  
  lines = []
  lines.append("## Test & Coverage summary\n\n")
  lines.append("| Metric | Value |\n")
  lines.append("|--------|-------|\n")
  lines.append(f"| Line coverage | {coverage:.2f}% ({covered}/{total}) |\n")

with open(step_summary, "a") as f:
  f.writelines(lines)
  PY

- name: Upload Jacoco HTML report
  if: always()
  uses: actions/upload-artifact@v4
  with:
    name: jacoco-report
    path: app/build/reports/jacoco/jacocoTestReport/html
    if-no-files-found: ignore

lint-and-style:
  name: Lint & Ktlint
  runs-on: ubuntu-latest
  needs: build

  steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: temurin
        java-version: 17

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    - name: Run ktlintCheck
      run: ./gradlew ktlintCheck

    - name: Run Android Lint
      run: ./gradlew lintDebug

    - name: Lint summary (Markdown)
      if: always()
      run: |
        LINT_XML="app/build/reports/lint-results-debug.xml"
        
        if [ ! -f "$LINT_XML" ]; then
          echo "## Lint & Style summary" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "Lint XML report not found: \`$LINT_XML\`" >> "$GITHUB_STEP_SUMMARY"
          exit 0
        fi
        
        python3 - << 'PY'
  import xml.etree.ElementTree as ET
  import os
  
  lint_xml = "app/build/reports/lint-results-debug.xml"
  step_summary = os.environ.get("GITHUB_STEP_SUMMARY")
  
  tree = ET.parse(lint_xml)
  root = tree.getroot()
  
  files = {}
  total_issues = 0

for issue in root.findall("issue"):
  for loc in issue.findall("location"):
    path = loc.get("file")
    if not path:
      continue
    files[path] = files.get(path, 0) + 1
    total_issues += 1

  lines = []
  lines.append("## Lint & Style summary\n\n")
  lines.append("| Metric | Value |\n")
  lines.append("|--------|-------|\n")
  lines.append(f"| Files with issues | {len(files)} |\n")
  lines.append(f"| Total lint issues | {total_issues} |\n\n")

if files:
  lines.append("### Files that still need fixes\n\n")
  for path, count in sorted(files.items()):
    lines.append(f"- `{path}` ({count} issue(s))\n")

with open(step_summary, "a") as f:
  f.writelines(lines)
  PY

- name: Upload Android Lint report
  if: always()
  uses: actions/upload-artifact@v4
  with:
    name: android-lint-report
    path: |
      app/build/reports/lint-results-debug.html
      app/build/reports/lint-results-debug.xml
    if-no-files-found: ignore

- name: Upload ktlint report
  if: always()
  uses: actions/upload-artifact@v4
  with:
    name: ktlint-report
    path: |
      **/build/reports/ktlint/**/*.xml
      **/build/reports/ktlint/**/*.txt
    if-no-files-found: ignore
