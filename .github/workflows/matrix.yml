name: Android CI

on:
  push:
    branches: [ "main", "develop", "feature/rick_and_morty" ]
  pull_request:
    branches: [ "main", "develop", "feature/rick_and_morty" ]

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build with Gradle
        uses: gradle/gradle-build-action@v3
        with:
          arguments: build

  test-and-coverage:
    name: Tests & Coverage
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      # Runs tests, generates coverage, prints in logs AND fails if < 50%
      - name: Run unit tests, coverage and enforce min 50%
        run: ./gradlew app:jacocoTestReport app:printJacocoCoverage app:jacocoTestCoverageVerification

      # === Coverage summary in Job Summary ===
      - name: Coverage summary (Markdown)
        if: always()
        run: |
          REPORT="app/build/reports/jacoco/jacocoTestReport/jacocoTestReport.xml"

          if [ ! -f "$REPORT" ]; then
            echo "## Quality summary (Tests & Coverage)" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "❌ Coverage report not found: \`$REPORT\`" >> "$GITHUB_STEP_SUMMARY"
            exit 0
          fi

          python3 - << 'PY'
  import os, re, pathlib
  
  report = pathlib.Path("app/build/reports/jacoco/jacocoTestReport/jacocoTestReport.xml")
  step_summary = os.environ["GITHUB_STEP_SUMMARY"]
  
  text = report.read_text(encoding="utf-8")
  
  pattern = re.compile(r'<counter[^>]*type="LINE"[^>]*missed="(\d+)"[^>]*covered="(\d+)"[^>]*/>')
  matches = pattern.findall(text)
  
  missed = sum(int(m[0]) for m in matches)
  covered = sum(int(m[1]) for m in matches)
  total = missed + covered
  coverage = (covered * 100.0 / total) if total else 0.0
  
  status_icon = "✅" if coverage >= 50.0 else "❌"

with open(step_summary, "a") as f:
  f.write("## Quality summary (Tests & Coverage)\n\n")
  f.write(f"{status_icon} **Jacoco coverage**\n\n")
  f.write("| Metric | Value |\n")
  f.write("|--------|-------|\n")
  f.write(f"| Line coverage | {coverage:.2f}% ({covered}/{total}) |\n")
  f.write(f"| Missing | {100.0-coverage:.2f}% ({missed} lines) |\n")
  PY

- name: Upload Jacoco HTML report
  if: always()
  uses: actions/upload-artifact@v4
  with:
    name: jacoco-report
    path: app/build/reports/jacoco/jacocoTestReport/html
    if-no-files-found: ignore

lint-and-style:
  name: Lint & Ktlint
  runs-on: ubuntu-latest
  needs: build

  steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: temurin
        java-version: 17

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    # ktlintCheck will FAIL the job if there is any violation
    - name: Run ktlintCheck (must be clean)
      run: ./gradlew ktlintCheck

    - name: Run Android Lint
      run: ./gradlew lintDebug

    # === Lint summary in Job Summary ===
    - name: Lint summary (Markdown)
      if: always()
      run: |
        LINT_XML="app/build/reports/lint-results-debug.xml"
        
        python3 - << 'PY'
  import os, pathlib, xml.etree.ElementTree as ET
  
  step_summary = os.environ["GITHUB_STEP_SUMMARY"]
  lint_xml_path = pathlib.Path("app/build/reports/lint-results-debug.xml")
  
  lines = []
  lines.append("## Quality summary (Lint & Style)\n\n")

if not lint_xml_path.exists():
  lines.append("❌ Lint report not found.\n")
else:
  tree = ET.parse(lint_xml_path)
  root = tree.getroot()
  
  files = {}
  total_warnings = 0
  total_errors = 0

  for issue in root.findall("issue"):
    severity = issue.get("severity", "").lower()
    if severity == "error":
      total_errors += 1
    elif severity == "warning":
      total_warnings += 1

    for loc in issue.findall("location"):
      path = loc.get("file")
      line = loc.get("line")
      if not path:
        continue
      key = (path, line)
      files[key] = files.get(key, 0) + 1

  # ktlint already fails if there are violations; here we just show Android Lint status
  icon = "✅" if total_warnings == 0 and total_errors == 0 else "⚠️"
  
  lines.append(f"{icon} **Android Lint**\n\n")
  lines.append("| Metric | Value |\n")
  lines.append("|--------|-------|\n")
  lines.append(f"| Errors | {total_errors} |\n")
  lines.append(f"| Warnings | {total_warnings} |\n\n")

  if files:
    lines.append("### Lint findings (sample)\n\n")
    lines.append("| File | Line | Count |\n")
    lines.append("|------|------|-------|\n")
    # limit to first 20 rows to keep summary readable
    for (path, line), count in list(sorted(files.items()))[:20]:
      lines.append(f"| `{path}` | {line or '-'} | {count} |\n")

with open(step_summary, "a") as f:
  f.writelines(lines)
  PY

- name: Upload Android Lint report
  if: always()
  uses: actions/upload-artifact@v4
  with:
    name: android-lint-report
    path: |
      app/build/reports/lint-results-debug.html
      app/build/reports/lint-results-debug.xml
    if-no-files-found: ignore

- name: Upload ktlint report
  if: always()
  uses: actions/upload-artifact@v4
  with:
    name: ktlint-report
    path: |
      **/build/reports/ktlint/**/*.xml
      **/build/reports/ktlint/**/*.txt
    if-no-files-found: ignore
